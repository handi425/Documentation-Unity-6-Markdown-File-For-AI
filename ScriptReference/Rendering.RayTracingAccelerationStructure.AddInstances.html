<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    <script type="text/javascript" src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" charset="UTF-8" data-domain-script="6e91be4c-3145-4ea2-aa64-89d716064836" data-dLayer-ignore="true" data-document-language="true">
    </script>
    <script type="text/javascript">function OptanonWrapper() {}</script>
    <script>window.dataLayer = window.dataLayer || []; dataLayer.push({ event: 'dataLayer-initialized', user: { user_unity_id: undefined, user_logged_in: 'no' }, environment: { environment_locale: 'en-us', environment_currency: undefined }});</script>
    <script>var offline=(location.href.indexOf('docs.unity3d.com')==-1)?true:false;if(!offline){(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&amp;l='+l:'';j.async=true;j.src=   'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);  })(window,document,'script','dataLayer','GTM-5V25JL6');}</script>
    <link href="https://fonts.googleapis.com/css?family=Roboto&amp;display=swap" rel="stylesheet" />
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Unity - Scripting API: Rendering.RayTracingAccelerationStructure.AddInstances</title>
    <meta property="og:image" content="https://unity3d.com/files/images/ogimg.jpg" />
    <meta name="author" content="Unity Technologies" />
    <link rel="shortcut icon" href="https://unity.com/themes/contrib/unity_base/images/favicons/favicon.ico" />
    <link rel="icon" type="image/png" href="../../../StaticFiles/images/favicons/favicon.png" />
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../StaticFiles/images/favicons/apple-touch-icon-152x152.png" />
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../StaticFiles/images/favicons/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon-precomposed" sizes="120x120" href="../StaticFiles/images/favicons/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../StaticFiles/images/favicons/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../StaticFiles/images/favicons/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon-precomposed" href="../StaticFiles/images/favicons/apple-touch-icon.png" />
    <link rel="canonical" href="https://docs.unity3d.com/6000.0/Documentation/ScriptReference/Rendering.RayTracingAccelerationStructure.AddInstances.html" />
    <meta name="msapplication-TileColor" content="#222c37" />
    <meta name="msapplication-TileImage" content="../StaticFiles/images/favicons/tileicon-144x144.png" />
    <script type="text/javascript" src="/StaticFilesConfig/UnityVersionsInfo.js">
    </script>
    <script type="text/javascript" src="../StaticFiles/js/jquery.js">
    </script>
    <script type="text/javascript" src="docdata/toc.js">//toc</script>
    <!--local TOC-->
    <script type="text/javascript" src="docdata/global_toc.js">//toc</script>
    <!--global TOC, including other platforms-->
    <script type="text/javascript" src="../StaticFiles/js/core.js">
    </script>
    <link rel="stylesheet" href="../StaticFiles/css/prism.css" />
    <script type="text/javascript" src="../StaticFiles/js/prism.js">
    </script>
    <link rel="stylesheet" type="text/css" href="../StaticFiles/css/core.css" />
    <script src="/StaticFilesConfig/feedback/feedback.js">
    </script>
    <script src="../StaticFiles/js/jquery.sidebar.min.js">
    </script>
    <script type="text/javascript" src="../StaticFiles/js/mobileoptimisation.js">
    </script>
    <link rel="stylesheet" href="../StaticFiles/css/mobileoptimisation.css" />
  </head>
  <body>
    <div id="DocsAnalyticsData" data-area="none" data-pagetype="scriptref">
    </div>
    <div class="header-wrapper">
      <div id="header" class="header">
        <div class="content">
          <div class="spacer">
            <div class="menu">
              <div id="nav-open" for="nav-input">
                <span>
                </span>
              </div>
              <div class="logo">
                <a href="">
                </a>
              </div>
              <div class="search-form">
                <form action="30_search.html" method="get" class="apisearch">
                  <input type="text" name="q" placeholder="Search scripting..." autosave="Unity Reference" results="5" class="sbox field" id="q">
                  </input>
                  <input type="submit" class="submit">
                  </input>
                </form>
              </div>
              <ul>
                <li>
                  <a href="../Manual/index.html">Manual</a>
                </li>
                <li>
                  <a href="../ScriptReference/index.html" class="selected">Scripting API</a>
                </li>
              </ul>
            </div>
          </div>
          <div class="more">
            <div class="filler">
            </div>
            <ul>
              <li>
                <a href="https://unity.com/">unity.com</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div class="toolbar">
        <div class="content clear">
          <div class="toggle version-number" id="VersionNumber" data-target=".otherversionscontent">
                                Version: <b>Unity 6</b> (6000.0)
                                <div class="otherversionscontent" id="OtherVersionsContent" style="display: none;"><ul id="OtherVersionsContentUl"></ul><div id="otherVersionsLegend"><ul><li><div id="supportedColour" class="legendBox"></div>Supported</li><li><div id="notFoundColour" class="legendBox"></div>Legacy</li></ul></div></div><div id="VersionSwitcherArrow" class="arrow versionSwitcherArrow"></div></div>
          <div class="lang-switcher hide">
            <div class="current toggle" data-target=".lang-list">
              <div class="lbl">Language<span class="b">English</span></div>
              <div class="arrow">
              </div>
            </div>
            <div class="lang-list" style="display:none;">
              <ul>
                <li>
                  <a href="">English</a>
                </li>
              </ul>
            </div>
          </div>
          <div class="script-lang">
            <ul>
              <li class="selected" data-lang="CS">C#</li>
            </ul>
          </div>
          <div class="mobileLogo">
            <a href="https://docs.unity3d.com">
            </a>
          </div>
        </div>
      </div>
    </div>
    <div id="master-wrapper" class="master-wrapper clear">
      <div id="sidebar" class="sidebar">
        <div class="sidebar-wrap">
          <div class="content">
            <div class="sidebar-menu">
              <div class="toc" id="customScrollbar">
                <h2>Scripting API</h2>
                <div class="search-form sidebar-search-form">
                  <form action="30_search.html" method="get" class="apisearch">
                    <input type="text" name="q" placeholder="Search manual..." autosave="Unity Reference" results="5" class="sbox field" id="q">
                    </input>
                    <input type="submit" id="mobileSearchBtn" class="submit" value="Search">
                    </input>
                  </form>
                </div>
                <div class="toggle version-number sidebar-version-switcher" id="VersionNumber" data-target=".otherversionscontent">
                  <form id="otherVersionsContentMobileForm">
                    <div class="ui-field-contain">
                      <label for="select-native-4">Version: Unity 6</label>
                      <select name="select-native-4" id="versionsSelectMobile">
                        <option>Select a different version</option>
                        <optgroup id="versionsWithThisPageMobile" label="Versions with this page">
                        </optgroup>
                        <optgroup id="versionsWithoutThisPageMobile" label="Versions without this page">
                        </optgroup>
                      </select>
                    </div>
                  </form>
                </div>
                <div class="lang-switcher hide">
                  <div class="toggle" data-target=".lang-list">
                    <div class="lbl">Language<span class="b">English</span></div>
                    <div class="arrow">
                    </div>
                  </div>
                  <div class="lang-list" style="display:none;">
                    <ul>
                      <li>
                        <a href="">English</a>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id="content-wrap" class="content-wrap">
        <div class="content-block">
          <div class="content">
            <div class="section">
              <div class="mb20 clear" id="">
                <h1 class="heading inherit">
                  <a href="Rendering.RayTracingAccelerationStructure.html">RayTracingAccelerationStructure</a>.AddInstances</h1>
                <div class="clear">
                </div>
                <div class="scrollToFeedback">
                  <a id="scrollToFeedback">Leave feedback</a>
                </div>
                <div class="clear">
                </div>
                <div class="suggest">
                  <a class="blue-btn sbtn">Suggest a change</a>
                  <div class="suggest-wrap rel hide">
                    <div class="loading hide">
                      <div>
                      </div>
                      <div>
                      </div>
                      <div>
                      </div>
                    </div>
                    <div class="suggest-success hide">
                      <h2>Success!</h2>
                      <p>Thank you for helping us improve the quality of Unity Documentation. Although we cannot accept all submissions, we do read each suggested change from our users and will make updates where applicable.</p>
                      <a class="gray-btn sbtn close">Close</a>
                    </div>
                    <div class="suggest-failed hide">
                      <h2>Submission failed</h2>
                      <p>For some reason your suggested change could not be submitted. Please &lt;a&gt;try again&lt;/a&gt; in a few minutes. And thank you for taking the time to help us improve the quality of Unity Documentation.</p>
                      <a class="gray-btn sbtn close">Close</a>
                    </div>
                    <div class="suggest-form clear">
                      <label for="suggest_name">Your name</label>
                      <input id="suggest_name" type="text">
                      </input>
                      <label for="suggest_email">Your email</label>
                      <input id="suggest_email" type="email">
                      </input>
                      <label for="suggest_body" class="clear">Suggestion<span class="r">*</span></label>
                      <textarea id="suggest_body" class="req">
                      </textarea>
                      <button id="suggest_submit" class="blue-btn mr10">Submit suggestion</button>
                      <p class="mb0">
                        <a class="cancel left lh42 cn">Cancel</a>
                      </p>
                    </div>
                  </div>
                </div>
                <a href="" class="switch-link gray-btn sbtn left hide">
                </a>
                <div class="clear">
                </div>
              </div>
              <div class="subsection">
                <div class="signature">
                  <div class="signature-CS sig-block">
                    <span style="color:red;">
                    </span>
                    <h2>Declaration</h2>public int <span class="sig-kw">AddInstances</span>(ref <a href="Rendering.RayTracingMeshInstanceConfig.html">Rendering.RayTracingMeshInstanceConfig</a> <span class="sig-kw">config</span>,
T[] <span class="sig-kw">instanceData</span>,
int <span class="sig-kw">instanceCount</span> = -1,
int <span class="sig-kw">startInstance</span> = 0,
uint <span class="sig-kw">id</span>);
    </div>
                  <div class="signature-CS sig-block">
                    <span style="color:red;">
                    </span>
                    <h2>Declaration</h2>public int <span class="sig-kw">AddInstances</span>(ref <a href="Rendering.RayTracingMeshInstanceConfig.html">Rendering.RayTracingMeshInstanceConfig</a> <span class="sig-kw">config</span>,
List&lt;T&gt; <span class="sig-kw">instanceData</span>,
int <span class="sig-kw">instanceCount</span> = -1,
int <span class="sig-kw">startInstance</span> = 0,
uint <span class="sig-kw">id</span>);
    </div>
                  <div class="signature-CS sig-block">
                    <span style="color:red;">
                    </span>
                    <h2>Declaration</h2>public int <span class="sig-kw">AddInstances</span>(ref <a href="Rendering.RayTracingMeshInstanceConfig.html">Rendering.RayTracingMeshInstanceConfig</a> <span class="sig-kw">config</span>,
NativeArray&lt;T&gt; <span class="sig-kw">instanceData</span>,
int <span class="sig-kw">instanceCount</span> = -1,
int <span class="sig-kw">startInstance</span> = 0,
uint <span class="sig-kw">id</span>);
    </div>
                  <div class="signature-CS sig-block">
                    <span style="color:red;">
                    </span>
                    <h2>Declaration</h2>public int <span class="sig-kw">AddInstances</span>(ref <a href="Rendering.RayTracingMeshInstanceConfig.html">Rendering.RayTracingMeshInstanceConfig</a> <span class="sig-kw">config</span>,
NativeSlice&lt;T&gt; <span class="sig-kw">instanceData</span>,
uint <span class="sig-kw">id</span>);
    </div>
                </div>
              </div>
              <div class="subsection">
                <h3>Parameters</h3>
                <table class="list">
                  <tr>
                    <td class="name lbl">config</td>
                    <td class="desc">The common parameters this array of ray tracing Mesh instance uses.</td>
                  </tr>
                  <tr>
                    <td class="name lbl">instanceData</td>
                    <td class="desc">An array of instance data used by the ray tracing Mesh instances.</td>
                  </tr>
                  <tr>
                    <td class="name lbl">instanceCount</td>
                    <td class="desc">The number of instances to add to the acceleration structure. When this argument is -1 (default), Unity adds all the instances from the startInstance to the end of the instanceData array.</td>
                  </tr>
                  <tr>
                    <td class="name lbl">startInstance</td>
                    <td class="desc">The first instance in the instanceData to add to the acceleration structure.</td>
                  </tr>
                  <tr>
                    <td class="name lbl">id</td>
                    <td class="desc">An optional instance ID value that you can access in HLSL with the <code class="mono">InstanceID()</code> function. Unity assigns consecutive instance IDs to each mesh instance, starting with the value of <code class="mono">id</code>.</td>
                  </tr>
                </table>
              </div>
              <div class="subsection">
                <h3>Returns</h3>
                <p>
                  <strong>int</strong>
        A value which represents a handle you can use to perform later actions (e.g. RemoveInstance, UpdateInstancePropertyBlock).
      </p>
              </div>
              <div class="subsection">
                <h3>Description</h3>
                <p>Adds an array of ray tracing Mesh instances to the RayTracingAccelerationStructure.</p>
              </div>
              <div class="subsection">
        <p>The passed instanceData can either be an array of <a href="Matrix4x4.html">Matrix4x4</a> (object-to-world transformation per instance) or a custom data structure. When the instanceData is a custom data structure, the structure can contain the following members:
</p>
        <ul>
          <li>
            <strong>Matrix4x4 objectToWorld</strong> (mandatory) - specifies per-instance object-to-world transformation matrix</li>
          <li>
            <strong>uint renderingLayerMask</strong> (optional) - specifies per-instance rendering layer mask</li>
          <li>
            <strong>Matrix4x4 prevObjectToWorld</strong> (optional) - specifies per-instance previous frame object-to-world transformation matrix (used for motion vector calculation)</li>
        </ul>
        <p>These members can appear in any order in the structure, but they must have the above name and type. AddInstances ignores any other members you include in the structure for your own use. The following example of a custom structure defines the mandatory objectToWorld member, an optional renderingLayerMask member, and a custom weight member (the AddInstances function ignores this member).</p>
      </div>
              <div class="subsection">
        <pre class="codeExampleCS">struct MyInstanceData
{
    public <a href="Matrix4x4.html">Matrix4x4</a> objectToWorld; // We must specify object-to-world transformation for each instance
    public uint renderingLayerMask; // Optional per-instance rendering layer mask.
    public float weight; // Additional per-instance data unrelated to rendering.
};</pre>
      </div>
              <div class="subsection">
        <p>For optimal CPU performance, MyInstanceData should contain objectToWorld member only, otherwise Unity must deinterleave the data.<br /><br />When AddInstances is in use, Unity enables <code class="varname">INSTANCING_ON</code> shader keyword. To declare the shader keyword in HLSL, add <code class="mono">#pragma multi_compile _ INSTANCING_ON</code> in the Shader Pass specified in <a href="Rendering.RayTracingShader.SetShaderPass.html">RayTracingShader.SetShaderPass</a> or <a href="Rendering.CommandBuffer.SetRayTracingShaderPass.html">CommandBuffer.SetRayTracingShaderPass</a>.
To access per-instance data relative to this array of ray tracing instances, use <code class="mono">InstanceIndex() - unity_BaseInstanceID</code> as an instance index in HLSL. For example, if prevObjectToWorld member is present in MyInstanceData structure, Unity copies the values into <code class="mono">unity_PrevObjectToWorldArray</code> buffer which you can define in HLSL as <code class="mono">StructuredBuffer&lt;float4x4&gt; unity_PrevObjectToWorldArray;</code> You can then index the buffer using <code class="mono">InstanceIndex() - unity_BaseInstanceID</code> difference. The following HLSL code snippet demonstrates how to compute a world-space velocity vector which is output in the ray payload:</p>
      </div>
              <div class="subsection">
        <pre class="codeExampleCS">#pragma multi_compile _ INSTANCING_ON<br /><br />struct AttributeData
{
    float2 barycentrics;
};<br /><br />struct RayPayload
{
    float3 velocity;
};<br /><br />// Built-in shader variables:
StructuredBuffer&lt;float4x4&gt; unity_PrevObjectToWorldArray;
float4x4 unity_MatrixPreviousM;
uint unity_BaseInstanceID;<br /><br />static uint unity_InstanceID;<br /><br />[shader("closesthit")]
void ClosestHitMain(inout RayPayload payload, AttributeData attribs)
{
   float3 localPos = ObjectRayOrigin() + RayTCurrent() * ObjectRayDirection();<br /><br />#if INSTANCING_ON
    unity_InstanceID = InstanceIndex() - unity_BaseInstanceID;
 
    float3 prevWorldPos = mul(unity_PrevObjectToWorldArray[unity_InstanceID], float4(localPos, 1)).xyz;
#else
    float3 prevWorldPos = mul(unity_MatrixPreviousM, float4(localPos, 1)).xyz;
#endif
    float3 worldPos = WorldRayOrigin() + RayTCurrent() * WorldRayDirection();<br /><br />    payload.velocity = worldPos - prevWorldPos;
}</pre>
      </div>
              <div class="subsection">
        <p>Depending on the parameters in config argument and the instanceData custom structure, AddInstances will set up and bind the following built-in StructuredBuffers to hit shaders:
</p>
        <ul>
          <li>
            <code class="mono">unity_PrevObjectToWorldArray</code> (float4x4) - when prevObjectToWorld member is present in instanceData custom structure.</li>
          <li>
            <code class="mono">unity_RenderingLayerArray</code> (float) - when renderingLayerMask member is present in instanceData custom structure.</li>
          <li>
            <code class="mono">unity_SHArArray</code>, <code class="mono">unity_SHAgArray</code>, <code class="mono">unity_SHAbArray</code>, <code class="mono">unity_SHBrArray</code>, <code class="mono">unity_SHBgArray</code>, <code class="mono">unity_SHBbArray</code>, <code class="mono">unity_SHCArray</code>  (float4) - spherical harmonics coefficients (used by ambient and light probes) when config.lightProbeUsage is <a href="Rendering.LightProbeUsage.Off.html">LightProbeUsage.Off</a> (ambient probe only), <a href="Rendering.LightProbeUsage.BlendProbes.html">LightProbeUsage.BlendProbes</a> or <a href="Rendering.LightProbeUsage.UseProxyVolume.html">LightProbeUsage.UseProxyVolume</a> (when config.lightProbeProxyVolume.qualityMode is set to <a href="LightProbeProxyVolume.QualityMode.Normal.html">LightProbeProxyVolume.QualityMode.Normal</a>).</li>
        </ul>
        <p>Note that AddInstances doesn't set up and bind <code class="mono">unity_ObjectToWorldArray</code> or <code class="mono">unity_WorldToObjectArray</code> buffers since you can access the ray tracing instance transformation matrices in hit shaders using <code class="mono">ObjectToWorld()</code> or <code class="mono">WorldToObject()</code> HLSL intrinsics.<br /><br />You can use this function to add a maximum of 1048575 ray tracing Mesh instances. The final instance count depends on both startInstance and instanceCount arguments. You can access the instance count in HLSL using <code class="mono">unity_InstanceCount</code> built-in uniform.<br /><br />AddInstances throws InvalidOperationException if the Material specified in the config argument doesn't have <a href="Material-enableInstancing.html">Material.enableInstancing</a> set to true.
 
When you have added all required instances, use <a href="Rendering.RayTracingAccelerationStructure.Build.html">RayTracingAccelerationStructure.Build</a> or <a href="Rendering.CommandBuffer.BuildRayTracingAccelerationStructure.html">CommandBuffer.BuildRayTracingAccelerationStructure</a> to build the acceleration structure on the GPU.<br /><br />This functionality doesn't have any special hardware requirements in addition to ray tracing support (<a href="SystemInfo-supportsRayTracing.html">SystemInfo.supportsRayTracing</a> must be true). In DirectX Raytracing (DXR), this function causes all ray tracing instances in the array to use only one shader record from the shader table, thus reducing the CPU overhead on the render thread for binding GPU resources to hit shaders.<br /><br />Additional resources: <a href="Rendering.RayTracingAccelerationStructure.AddInstance.html">RayTracingAccelerationStructure.AddInstance</a>, <a href="Rendering.RayTracingAccelerationStructure.RemoveInstance.html">RayTracingAccelerationStructure.RemoveInstance</a>.</p>
      </div>
            </div>
            <div class="section">
              <div id="_content">
              </div>
            </div>
            <div class="footer-wrapper">
              <div class="footer clear">
                <div class="copy">
                  <p>
                    <known_issues>Is something described here not working as you expect it to? It might be a <b>Known Issue</b>. Please check with the Issue Tracker at </known_issues>
                    <a href="https://issuetracker.unity3d.com">issuetracker.unity3d.com</a>.</p>Copyright ©2005-2025 Unity Technologies. All rights reserved. Built from: 6000.0.36f1 (02b661dc617c). Built on: 2025-01-14.
                                        </div>
                <div class="menu">
                  <a href="https://unity3d.com/learn">Tutorials</a>
                  <a href="https://answers.unity3d.com">Community Answers</a>
                  <a href="https://support.unity3d.com/hc/en-us">Knowledge Base</a>
                  <a href="https://forum.unity3d.com">Forums</a>
                  <a href="https://unity3d.com/asset-store">Asset Store</a>
                  <a href="https://docs.unity3d.com/Manual/TermsOfUse.html">Terms of use</a>
                  <a href="https://unity.com/legal">Legal</a>
                  <a href="https://unity.com/legal/privacy-policy">Privacy Policy</a>
                  <a href="https://unity.com/legal/cookie-policy">Cookies</a>
                  <a href="https://unity.com/legal/do-not-sell-my-personal-information">Do Not Sell or Share My Personal Information</a>
                  <div id="ot-sdk-btn-container">
                    <a id="ot-sdk-btn" class="ot-sdk-show-settings" href="javascript:void(0);">Your Privacy Choices (Cookie Settings)</a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>